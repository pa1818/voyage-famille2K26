<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Index ‚Äì Vote Familial (Destinations)</title>
  <meta name="description" content="Site familial pour proposer des destinations et voter en 5 √©toiles, avec classement en temps r√©el via Firebase Realtime Database." />
  <style>
    body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; background: linear-gradient(135deg, #f0f4ff, #dbeafe); color: #333; }
    header { background: linear-gradient(90deg, #007bff, #00c6ff); color: #fff; padding: 1.5rem; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    header h1 { margin: 0; font-size: 1.8rem; }
    main { padding: 2rem 1rem; max-width: 950px; margin: auto; }
    h2 { margin-top: 2.5rem; color: #007bff; border-bottom: 2px solid #e0e7ff; padding-bottom: 0.5rem; }
    .card { background: #fff; padding: 1.2rem; margin-bottom: 1rem; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); transition: transform 0.2s ease; }
    .card:hover { transform: translateY(-3px); }
    .btn { padding: 0.6rem 1.2rem; margin: 0.3rem; border: none; border-radius: 10px; cursor: pointer; font-weight: 500; transition: 0.2s ease; }
    .primary { background: linear-gradient(90deg, #007bff, #00c6ff); color: #fff; }
    .primary:hover { opacity: 0.9; }
    .danger { background: #ef4444; color: #fff; }
    .danger:hover { background: #dc2626; }
    .star { font-size: 1.5rem; cursor: pointer; color: #ccc; transition: color 0.2s ease; }
    .star:hover { color: #fbbf24; }
    .star.selected { color: #f59e0b; }
    input, textarea { width: 100%; padding: 0.7rem; margin: 0.5rem 0; border-radius: 8px; border: 1px solid #cbd5e1; font-size: 1rem; }
    textarea { resize: vertical; }
    #ranking .card { display: flex; justify-content: space-between; align-items: center; font-size: 1rem; }
    footer { text-align: center; padding: 1rem; font-size: 0.9rem; color: #6b7280; margin-top: 2rem; }
  </style>
</head>
<body>
  <header>
    <h1>üèñÔ∏è Vote Familial pour les Destinations</h1>
  </header>
  <main>
    <section id="propositions">
      <h2>Propositions de voyages</h2>
      <div id="prop-list"></div>
      <input type="text" id="prop-destination" placeholder="Destination (max 2 par membre)" />
      <textarea id="prop-argument" placeholder="Arguments" rows="3"></textarea>
      <button id="addPropBtn" class="btn primary">‚ûï Ajouter</button>
    </section>

    <section id="votes">
      <h2>Noter les destinations</h2>
      <div id="vote-list"></div>
      <button id="submitVotesBtn" class="btn primary">‚úÖ Soumettre mes votes</button>
    </section>

    <section id="classement">
      <h2>Classement</h2>
      <div id="ranking"></div>
    </section>
  </main>

  <footer>
    üåê Site familial ‚Äì Propositions et votes en temps r√©el avec Firebase
  </footer>

  <div style="position:fixed;bottom:1rem;right:1rem;">
    <button id="downloadBtn" class="btn primary">üì• T√©l√©charger</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getDatabase, ref, set, push, onValue, remove, get } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDpeCfu5oP_PsYJrcSHswo57A7DoLsaCkk",
      authDomain: "voyage-famille-2k26.firebaseapp.com",
      databaseURL: "https://voyage-famille-2k26-default-rtdb.europe-west1.firebasedatabase.app/",
      projectId: "voyage-famille-2k26",
      storageBucket: "voyage-famille-2k26.firebasestorage.app",
      messagingSenderId: "536799085283",
      appId: "1:536799085283:web:20cf70df19ebb3d201bbd6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const propList = document.getElementById('prop-list');
    const voteList = document.getElementById('vote-list');
    const rankingDiv = document.getElementById('ranking');

    const addPropBtn = document.getElementById('addPropBtn');
    const submitVotesBtn = document.getElementById('submitVotesBtn');

    let localVotes = {};

    function renderStars(destId) {
      let starsHtml = '';
      for (let i = 1; i <= 5; i++) {
        starsHtml += `<span class="star" data-dest="${destId}" data-val="${i}">‚òÖ</span>`;
      }
      return starsHtml;
    }

    // Ajouter une proposition
    addPropBtn.addEventListener('click', () => {
      const dest = document.getElementById('prop-destination').value.trim();
      const arg = document.getElementById('prop-argument').value.trim();
      if (!dest) return;
      const newRef = push(ref(db, 'propositions'));
      set(newRef, { destination: dest, argument: arg });
      document.getElementById('prop-destination').value = '';
      document.getElementById('prop-argument').value = '';
    });

    // Supprimer une proposition
    function deleteProp(id) {
      remove(ref(db, 'propositions/' + id));
      remove(ref(db, 'votes/' + id));
    }

    // Afficher les propositions + votes
    onValue(ref(db, 'propositions'), snapshot => {
      propList.innerHTML = '';
      voteList.innerHTML = '';
      const data = snapshot.val();
      if (!data) return;
      Object.entries(data).forEach(([id, prop]) => {
        // Carte proposition
        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `<strong>${prop.destination}</strong><br><em>${prop.argument}</em><br>` +
                        `<button class="btn danger" onclick="deleteProp('${id}')">üóëÔ∏è Supprimer</button>`;
        propList.appendChild(div);

        // Carte vote
        const voteDiv = document.createElement('div');
        voteDiv.className = 'card';
        voteDiv.innerHTML = `<strong>${prop.destination}</strong><div>${renderStars(id)}</div>` +
                            `<button class="btn danger" onclick="deleteVote('${id}')">‚ùå Effacer mon vote</button>`;
        voteList.appendChild(voteDiv);
      });
      initStarListeners();
    });

    // Gestion des votes en local
    function initStarListeners() {
      document.querySelectorAll('.star').forEach(star => {
        star.addEventListener('click', () => {
          const dest = star.dataset.dest;
          const val = parseInt(star.dataset.val);
          localVotes[dest] = val;
          document.querySelectorAll(`.star[data-dest='${dest}']`).forEach(s => s.classList.remove('selected'));
          for (let i = 1; i <= val; i++) {
            document.querySelector(`.star[data-dest='${dest}'][data-val='${i}']`).classList.add('selected');
          }
        });
      });
    }

    // Soumettre votes
    submitVotesBtn.addEventListener('click', () => {
      Object.entries(localVotes).forEach(([dest, val]) => {
        set(ref(db, 'votes/' + dest + "/" + Date.now()), val);
      });
      localVotes = {};
      alert('‚úÖ Votes soumis !');
    });

    // Supprimer son vote
    window.deleteVote = (destId) => {
      remove(ref(db, 'votes/' + destId));
    }

    // Classement avec noms au lieu d'ID
    onValue(ref(db, 'votes'), async snapshot => {
      const votes = snapshot.val();
      if (!votes) { rankingDiv.innerHTML = 'Pas encore de votes.'; return; }

      const scores = {};
      for (const [destId, allVotes] of Object.entries(votes)) {
        const vals = Object.values(allVotes);
        const avg = vals.reduce((a,b)=>a+b,0)/vals.length;
        // R√©cup√©rer le nom de la destination
        const propSnap = await get(ref(db, 'propositions/' + destId));
        const name = propSnap.exists() ? propSnap.val().destination : destId;
        scores[name] = avg;
      }

      let html = '';
      Object.entries(scores).sort((a,b)=>b[1]-a[1]).forEach(([name, avg]) => {
        html += `<div class='card'><strong>${name}</strong> <span>${avg.toFixed(2)} ‚≠ê</span></div>`;
      });
      rankingDiv.innerHTML = html;
    });

    window.deleteProp = deleteProp;
  </script>

  <script>
    document.getElementById('downloadBtn').addEventListener('click', () => {
      const blob = new Blob([document.documentElement.outerHTML], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'vote_familial.html';
      a.click();
      URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>
