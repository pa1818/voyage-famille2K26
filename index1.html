<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Index ‚Äì Vote Familial (Destinations)</title>
  <meta name="description" content="Site familial pour proposer des destinations et voter en 5 √©toiles, avec classement en temps r√©el via Firebase Realtime Database." />
  <style>
    /* (Ton CSS √©pur√© ici, comme pr√©c√©demment) */
    :root {
      --bg: #0b1020;
      --card: #121933;
      --muted: #8ea0ff;
      --accent: #6ea8ff;
      --text: #e8ecff;
      --ok: #20c997;
      --warn: #f59f00;
      --danger: #ff6b6b;
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius: 18px;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif; background: radial-gradient(1200px 800px at 10% -10%, #1a2459 0%, transparent 60%), radial-gradient(1200px 800px at 100% 10%, #18224e 0%, transparent 50%), var(--bg); color: var(--text); }

    header { position: sticky; top: 0; z-index: 10; background: rgba(11,16,32,.7); backdrop-filter: blur(8px); border-bottom: 1px solid rgba(255,255,255,.08); }
    .bar { max-width: 1080px; margin: 0 auto; padding: .75rem 1rem; display: grid; grid-template-columns: 1fr auto; align-items: center; gap: 1rem; }
    .brand { display:flex; align-items:center; gap:.6rem; font-weight: 700; letter-spacing:.3px; }
    .brand .logo { width: 36px; height: 36px; display:grid; place-items:center; background: linear-gradient(135deg, #6790ff, #93c2ff); color:#00103a; border-radius: 12px; box-shadow: var(--shadow); font-size: 20px; }
    nav { display:flex; gap:.4rem; flex-wrap: wrap; }
    .tab { padding:.55rem .9rem; border-radius: 999px; border:1px solid rgba(255,255,255,.12); color:#cfe0ff; text-decoration:none; font-weight:600; font-size:.95rem; }
    .tab.active { background: linear-gradient(135deg, #3f64ff, #6aa6ff); color:#04122e; border-color: transparent; }

    .wrap { max-width: 1080px; margin: 0 auto; padding: 1rem; }
    .grid { display:grid; gap: 1rem; grid-template-columns: 1fr 1fr; }
    @media (max-width: 900px){ .grid { grid-template-columns: 1fr; } }

    .card { background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02)); border: 1px solid rgba(255,255,255,.08); border-radius: var(--radius); box-shadow: var(--shadow); padding: 1rem; }
    h1, h2, h3 { margin: .2rem 0 .6rem; }
    h1 { font-size: 1.35rem; letter-spacing:.2px; opacity:.95; }
    h2 { font-size: 1.1rem; color: var(--muted); font-weight: 700; }
    p.muted { color: #c4d1ff; opacity:.85; }

    label { display:block; margin:.35rem 0 .25rem; font-size:.95rem; color:#cfe0ff; }
    input, select, textarea, button { width: 100%; padding: .8rem .9rem; border-radius: 12px; border:1px solid rgba(255,255,255,.14); background: rgba(255,255,255,.06); color: var(--text); font-size: 1rem; }
    textarea { min-height: 100px; resize: vertical; }
    input::placeholder, textarea::placeholder { color: #b6c5ff; opacity:.7; }

    .row { display:flex; gap:.6rem; }
    .row > * { flex:1; }
    .actions { display:flex; gap:.6rem; align-items:center; justify-content:flex-end; margin-top:.6rem; }
    .btn { cursor: pointer; font-weight: 700; letter-spacing:.2px; }
    .btn.primary { background: linear-gradient(135deg, #4b6bff, #7fb4ff); color:#071536; border:none; }
    .btn.ghost { background: transparent; border:1px solid rgba(255,255,255,.18); }
    .btn.warn { background: linear-gradient(135deg, #f7b733, #fc8f2b); color:#1a1000; border:none; }

    .section { display:none; }
    .section.active { display:block; }

    .list { display:grid; gap:.8rem; }
    .pill { display:inline-flex; align-items:center; gap:.45rem; padding:.35rem .6rem; border-radius:999px; border:1px solid rgba(255,255,255,.16); background: rgba(255,255,255,.06); font-size:.9rem; }

    .proposal { padding: .9rem; border-radius: 14px; border: 1px solid rgba(255,255,255,.14); background: rgba(255,255,255,.04); }
    .proposal h4 { margin:.1rem 0 .2rem; }
    .meta { font-size:.9rem; color:#cfe0ff; opacity:.9; }

    .stars { display:flex; gap:.25rem; font-size: 1.4rem; user-select: none; }
    .star { cursor: pointer; transition: transform .08s ease; }
    .star:hover { transform: scale(1.15); }
    .star.active { color: #ffd267; }

    .ranking { display:grid; gap:.6rem; }
    .rank-item { display:flex; align-items:center; gap:.65rem; padding:.65rem .75rem; border-radius:12px; border:1px solid rgba(255,255,255,.14); background: rgba(255,255,255,.04); }
    .rank-medal { width:28px; height:28px; display:grid; place-items:center; border-radius:999px; background:#24306a; font-weight:800; }
    .medal-1 { background: linear-gradient(135deg, #ffd54f, #ff9800); color:#2a1600; }
    .medal-2 { background: linear-gradient(135deg, #d7e3ff, #a8b8ff); color:#0f1533; }
    .medal-3 { background: linear-gradient(135deg, #ffd7b3, #ffaf66); color:#201206; }

    .hint { font-size:.9rem; color:#cfe0ff; opacity:.85; }
    .divider { height:1px; background: rgba(255,255,255,.08); margin:.75rem 0; }
  </style>
</head>
<body>
  <!-- HEADER / NAV -->
  <header>
    <div class="bar">
      <div class="brand">
        <div class="logo">‚úàÔ∏è</div>
        <div>
          <div style="font-size:1.05rem;">Vote Familial ‚Äì Destinations</div>
          <div class="hint" id="whoami">Membre actif : <span id="whoami-name">‚Äî</span></div>
        </div>
      </div>
      <nav>
        <a href="#home" class="tab active" data-tab="home">üè† Maison</a>
        <a href="#profile" class="tab" data-tab="profile">üë§ Profil</a>
        <a href="#ranking" class="tab" data-tab="ranking">üèÜ Classement</a>
        <a href="#help" class="tab" data-tab="help">üìò Aide</a>
      </nav>
    </div>
  </header>

  <main class="wrap">
    <!-- SECTION: HOME -->
    <section id="home" class="section active">
      <div class="grid">
        <div class="card">
          <h1>Bienvenue üëã</h1>
          <p class="muted">Chaque membre propose <b>2 destinations</b> avec arguments. Tout le monde note de <b>1 √† 5 √©toiles</b>. Le <b>classement</b> se met √† jour en temps r√©el.</p>
          <div class="divider"></div>
          <h2>1) Choisir le membre actif</h2>
          <label for="activeMember">Je suis :</label>
          <div class="row">
            <select id="activeMember"></select>
            <button class="btn ghost" id="btnSwitch">Utiliser ce membre</button>
          </div>
          <p class="hint">Le membre actif est m√©moris√© sur l‚Äôappareil.</p>

          <div class="divider"></div>
          <h2>2) Ajouter un membre</h2>
          <label for="memberName">Pr√©nom du membre</label>
          <div class="row">
            <input id="memberName" placeholder="ex: L√©a" />
            <button class="btn primary" id="addMember">Ajouter</button>
          </div>
          <p class="hint">Chaque personne ajoute son propre membre.</p>
        </div>

        <div class="card">
          <h2>Membres existants</h2>
          <div id="memberList" class="list"></div>
        </div>
      </div>
    </section>

    <!-- SECTION: PROFILE -->
    <section id="profile" class="section">
      <div class="grid">
        <div class="card">
          <h2>Proposer une destination (max 2)</h2>
          <label for="proposalTitle">Destination</label>
          <input id="proposalTitle" placeholder="ex: Rome" />
          <label for="proposalArgs">Arguments</label>
          <textarea id="proposalArgs" placeholder="Soleil, budget..."></textarea>
          <div class="actions">
            <button class="btn primary" id="addProposal">Ajouter</button>
          </div>
          <p class="hint">Soyez concis => max 2 propositions.</p>
        </div>

        <div class="card">
          <h2>Toutes les propositions</h2>
          <div id="proposalList" class="list"></div>
        </div>
      </div>
    </section>

    <!-- SECTION: RANKING -->
    <section id="ranking" class="section">
      <div class="card">
        <h2>Classement g√©n√©ral</h2>
        <div id="results" class="ranking"></div>
      </div>
    </section>

    <!-- SECTION: HELP -->
    <section id="help" class="section">
      <div class="card">
        <h2>Configuration Firebase (r√©sum√©)</h2>
        <ol>
          <li>Cr√©e un projet sur <b>console.firebase.google.com</b>.</li>
          <li>Ajoute une app Web (ic√¥ne <b>&lt;/&gt;</b>) et r√©cup√®re le <b>firebaseConfig</b>.</li>
          <li>Active <b>Realtime Database</b> (mode test) et note l‚Äô<b>URL</b>.</li>
          <li>Colle la config dans le bloc <i>CONFIGURATION</i> ci-dessus.</li>
        </ol>
        <p class="hint">Ensuite, d√©ploie sur GitHub Pages pour partager √† la famille.</p>
      </div>
    </section>
  </main>

  <!-- SCRIPT APP -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, set, get, onValue, push } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDpeCfu5oP_PsYJrcSHswo57A7DoLsaCkk",
      authDomain: "voyage-famille-2k26.firebaseapp.com",
      databaseURL: "https://voyage-famille-2k26-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "voyage-famille-2k26",
      storageBucket: "voyage-famille-2k26.appspot.com",
      messagingSenderId: "536799085283",
      appId: "1:536799085283:web:20cf70df19ebb3d201bbd6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const $ = id => document.getElementById(id);
    const sectionEls = { home: $("home"), profile: $("profile"), ranking: $("ranking"), help: $("help") };
    const tabs = document.querySelectorAll('.tab');

    function show(tab) {
      Object.values(sectionEls).forEach(s => s.classList.remove('active'));
      sectionEls[tab].classList.add('active');
      tabs.forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
      if (tab === 'ranking') computeRanking();
    }
    tabs.forEach(t => t.addEventListener('click', e => { e.preventDefault(); show(t.dataset.tab); }));

    let currentMember = localStorage.getItem('currentMember') || '';
    function updateWhoAmI() { $("whoami-name").textContent = currentMember || '‚Äî'; }
    updateWhoAmI();

    $("addMember").addEventListener('click', async () => {
      const name = $("memberName").value.trim();
      if (!name) return alert('Entre un pr√©nom');
      await set(ref(db, `members/${name}`), true);
      $("memberName").value = '';
      currentMember = name;
      localStorage.setItem('currentMember', name);
      updateWhoAmI();
    });

    $("btnSwitch").addEventListener('click', () => {
      const sel = $("activeMember");
      if (!sel.value) return alert('Choisis un membre');
      currentMember = sel.value;
      localStorage.setItem('currentMember', sel.value);
      updateWhoAmI();
    });

    const membersRef = ref(db, 'members');
    function renderMembers(list) {
      const ul = $("memberList"); ul.innerHTML = '';
      const sel = $("activeMember"); sel.innerHTML = '<option value="">‚Äî Choisir un membre ‚Äî</option>';
      Object.keys(list).sort().forEach(m => {
        const pill = document.createElement('div'); pill.className = 'pill'; pill.textContent = m; ul.appendChild(pill);
        const opt = document.createElement('option'); opt.value = m; opt.textContent = m; sel.appendChild(opt);
      });
      if (currentMember && list[currentMember]) sel.value = currentMember;
    }
    onValue(membersRef, snap => renderMembers(snap.val() || {}));

    const proposalsRef = ref(db, 'proposals');
    $("addProposal").addEventListener('click', async () => {
      if (!currentMember) return alert("Choisis/ajoute ton membre d'abord");
      const title = $("proposalTitle").value.trim();
      const args = $("proposalArgs").value.trim();
      if (!title || !args) return alert("Titre et arguments requis");
      const snap = await get(proposalsRef);
      const all = snap.val() || {};
      const count = Object.values(all).filter(p => p.author === currentMember).length;
      if (count >= 2) return alert("Tu as d√©j√† 2 propositions");
      const idRef = push(proposalsRef);
      await set(idRef, { id: idRef.key, title, args, author: currentMember, createdAt: Date.now() });
      $("proposalTitle").value = '';
      $("proposalArgs").value = '';
    });

    function renderProposals(list) {
      const box = $("proposalList"); box.innerHTML = '';
      const entries = Object.values(list || {});
      entries.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
      entries.forEach(p => {
        const item = document.createElement('div'); item.className = 'proposal';
        const title = document.createElement('h4'); title.textContent = p.title; item.appendChild(title);
        const meta = document.createElement('div'); meta.className = 'meta'; meta.textContent = `Propos√© par ${p.author}`; item.appendChild(meta);
        const txt = document.createElement('div'); txt.textContent = p.args; item.appendChild(txt);
        const stars = document.createElement('div'); stars.className = 'stars';
        for (let i = 1; i <= 5; i++) {
          const s = document.createElement('span'); s.textContent = '‚òÖ'; s.className = 'star';
          s.addEventListener('click', () => {
            if (!currentMember) return alert("S√©lectionne ton membre (Maison)");
            set(ref(db, `ratings/${p.id}/${currentMember}`), i);
          });
          onValue(ref(db, `ratings/${p.id}/${currentMember}`), snap => {
            if ((snap.val() || 0) >= i) s.classList.add('active');
            else s.classList.remove('active');
          });
          stars.appendChild(s);
        }
        item.appendChild(stars);
        box.appendChild(item);
      });
    }
    onValue(proposalsRef, snap => renderProposals(snap.val()));

    async function computeRanking() {
      const allSnap = await get(proposalsRef);
      const all = allSnap.val() || {};
      const resultsBox = $("results"); resultsBox.innerHTML = '';
      const list = Object.values(all);
      const scores = await Promise.all(list.map(async p => {
        const r = (await get(ref(db, `ratings/${p.id}`))).val() || {};
        const arr = Object.values(r);
        const avg = arr.length ? arr.reduce((a, b) => a + b, 0) / arr.length : 0;
        return { ...p, avg, count: arr.length };
      }));
      scores.sort((a, b) => b.avg - a.avg);
      scores.forEach((s, idx) => {
        const row = document.createElement('div'); row.className = 'rank-item';
        const medal = document.createElement('div'); medal.className = 'rank-medal ' + (idx === 0 ? 'medal-1' : idx === 1 ? 'medal-2' : idx === 2 ? 'medal-3' : '');
        medal.textContent = idx + 1; row.appendChild(medal);
        const info = document.createElement('div');
        info.innerHTML = `<b>${s.title}</b> ‚Äì par ${s.author}<br><span class="hint">Moyenne: ${s.avg.toFixed(2)} ‚≠ê ‚Ä¢ ${s.count} vote(s)</span><br><span class="meta">${s.args}</span>`;
        row.appendChild(info);
        resultsBox.appendChild(row);
      });
    }
    // also update ranking on rating changes
    onValue(ref(db, 'ratings'), () => computeRanking());

    show('home');
  </script>
</body>
</html>
